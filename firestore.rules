/**
 * @fileOverview
 * This ruleset enforces a strict user-ownership model for user profiles and user-movie interactions.
 * It allows public read access to movies and genres, but restricts write access to SUPER_ADMIN users.
 * SUPER_ADMINS can also manage all user roles and application settings.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. Readable by SUPER_ADMINS, writable only by the user themselves or a SUPER_ADMIN.
 * - /movies/{movieId}: Stores movie details, publicly readable, but only SUPER_ADMIN users can modify.
 * - /genres/{genreId}: Stores movie genres, publicly readable, but only SUPER_ADMIN users can modify.
 * - /users/{userId}/userMovies/{userMovieId}: Stores user-specific movie data, accessible only to the user themselves.
 * - /settings/app: Stores global application settings, readable by all, writable only by SUPER_ADMINS.
 *
 * Key Security Decisions:
 * - User listing is restricted to SUPER_ADMINS to protect user privacy.
 * - SUPER_ADMIN role is required for creating, updating, and deleting movies and genres, and for managing user roles and settings.
 * - Read-only access is granted to the /movies, /genres and /settings collections for all users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to manage their own profile. SUPER_ADMINS can manage any user profile.
     * @path /users/{userId}
     * @allow (get, update) User can manage their own profile, SUPER_ADMIN can manage any.
     * @allow (list) SUPER_ADMINS can list all users.
     * @allow (create) New users can create their own profile document.
     * @principle Enforces document ownership for writes and reads, with role-based overrides.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin(); // Only admins can list users.
      allow create: if request.auth.uid == userId; // A user can create their own document.
      allow update: if isOwner(userId) || isAdmin(); // Admin can change roles, user can change their own info.
      // Allow admin to delete users, but not other SUPER_ADMINS for safety.
      allow delete: if isAdmin() && resource.data.role != 'SUPER_ADMIN'; 
    }

    /**
     * @description Allows anyone to read movies, but only SUPER_ADMINs can create, update, or delete them.
     * @path /movies/{movieId}
     * @allow (get, list) Any user can read movie details.
     * @allow (create, update, delete) Only a SUPER_ADMIN user can create, update, or delete movie details.
     * @deny  (create, update, delete) A regular user cannot create, update, or delete movie details.
     * @principle Restricts write access based on user role.
     */
    match /movies/{movieId} {
      allow get, list: if true;
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin() && resource != null;
      allow delete: if isSignedIn() && isAdmin() && resource != null;
    }

    /**
     * @description Allows anyone to read genres, but only SUPER_ADMINs can create, update, or delete them.
     * @path /genres/{genreId}
     * @allow (get, list) Any user can read genre details.
     * @allow (create, update, delete) Only a SUPER_ADMIN user can create, update, or delete genre details.
     * @deny  (create, update, delete) A regular user cannot create, update, or delete genre details.
     * @principle Restricts write access based on user role.
     */
    match /genres/{genreId} {
      allow get, list: if true;
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin() && resource != null;
      allow delete: if isSignedIn() && isAdmin() && resource != null;
    }

    /**
     * @description Allows users to manage their own movie interactions (e.g., want to watch, rating).
     * @path /users/{userId}/userMovies/{userMovieId}
     * @allow (create, get, update, delete) User with ID 'user123' can access/modify their movie interactions if request.auth.uid == 'user123'.
     * @deny  (create, get, update, delete) User with ID 'user456' cannot access/modify User 'user123' movie interactions.
     * @principle Enforces document ownership for writes and reads.
     */
    match /users/{userId}/userMovies/{userMovieId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId; // Force userId on create.
      allow update: if isOwner(userId) && resource.data.userId == userId; //Immutable userId.
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores global application settings. Writable only by SUPER_ADMINS, readable by all.
     * @path /settings/{settingId}
     * @allow (get, list) Any user can read settings.
     * @allow (create, update, delete) Only a SUPER_ADMIN user can manage settings.
     * @principle Centralizes settings management with role-based write access.
     */
    match /settings/{settingId} {
        allow get: if true;
        allow list: if true;
        allow create, update, delete: if isSignedIn() && isAdmin();
    }


    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPER_ADMIN';
    }
  }
}
